# Design Apple Maps - Development with Claude

## Project Context

Building a navigation platform to understand routing algorithms, real-time traffic, and map rendering.

**Key Learning Goals:**
- Build graph-based routing algorithms
- Design real-time traffic aggregation
- Implement tile-based map serving
- Handle GPS data at scale

---

## Key Challenges to Explore

### 1. Routing Performance

**Challenge**: Sub-second route calculation

**Approaches:**
- Contraction hierarchies
- A* with hierarchical decomposition
- Precomputed transit nodes
- Bidirectional search

### 2. Traffic Accuracy

**Problem**: Real-time traffic from sparse probes

**Solutions:**
- GPS probe aggregation
- Historical patterns
- Incident detection
- ML-based prediction

### 3. Map Matching

**Challenge**: Snap GPS to road network

**Solutions:**
- Hidden Markov Model
- Viterbi algorithm
- Heading and speed constraints
- Confidence scoring

---

## Development Phases

### Phase 1: Map Data - Completed
- [x] Road graph import (grid-based network seeder)
- [x] Tile generation (using OpenStreetMap tiles via Leaflet)
- [x] Geocoding (address to coordinate conversion)
- [x] POI search (full-text search with categories)

### Phase 2: Routing - In Progress
- [x] Basic A* pathfinding (with priority queue)
- [ ] Contraction hierarchies
- [x] Turn-by-turn maneuvers
- [ ] Alternative routes

### Phase 3: Traffic - In Progress
- [x] GPS probe ingestion (simulated)
- [x] Segment aggregation
- [x] Incident detection (basic)
- [x] ETA prediction (traffic-aware)

### Phase 4: Navigation
- [x] Real-time tracking (basic)
- [ ] Rerouting
- [ ] Voice guidance
- [ ] Offline support

---

## Implementation Notes

### A* Routing Algorithm

The routing engine uses A* with the following features:
- **Priority Queue**: Binary min-heap implementation for O(log n) operations
- **Heuristic**: Haversine distance with assumed highway speed (100 km/h)
- **Edge Weights**: Time-based (distance / speed), adjusted for traffic
- **Constraints**: Support for avoiding tolls and highways

### Traffic Simulation

Traffic is simulated with:
- Rush hour patterns (7-9 AM, 5-7 PM)
- Random speed variations (70-100% of free flow)
- Updates every 10 seconds
- Four congestion levels: free, light, moderate, heavy

### Maneuver Generation

Turn-by-turn directions are generated by:
1. Calculating bearing between consecutive edges
2. Computing turn angle from bearing difference
3. Classifying turns (straight, slight, normal, sharp, u-turn)
4. Generating human-readable instructions

### Database Schema

Key tables:
- `road_nodes`: Graph vertices with lat/lng coordinates
- `road_segments`: Graph edges with street names, speed limits
- `traffic_flow`: Time-series traffic data
- `incidents`: Active traffic incidents
- `pois`: Points of interest with categories

---

## Resources

- [OSRM - Open Source Routing Machine](https://project-osrm.org/)
- [Contraction Hierarchies](https://algo2.iti.kit.edu/schultes/hwy/contract.pdf)
- [Map Matching with HMM](https://www.microsoft.com/en-us/research/publication/hidden-markov-map-matching-through-noise-and-sparseness/)
- [Leaflet Documentation](https://leafletjs.com/)
- [PostGIS Documentation](https://postgis.net/documentation/)

---

## Next Steps

1. **Contraction Hierarchies**: Precompute shortcuts for faster routing
2. **Alternative Routes**: Implement penalty method for diverse routes
3. **Rerouting**: Detect off-route and recalculate
4. **Voice Guidance**: Text-to-speech for navigation instructions
5. **Offline Maps**: Download and cache map tiles locally
